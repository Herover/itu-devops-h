### Deployment

#### Minitwit

To deploy a change to the Minitwit application, a pull request must be merged to main. This action will set off a pipeline in our CI/CD system that goes through the following steps:

[start=0]
. Pull copy of newest code to docker container
. Create and push docker image
   Using Drones “plugins/docker” image, we build a docker image of Minitwit and push it to our private docker registry
. Snyk scan
   Scan the new docker image using snyk for security issues
. Update live docker images
+
Using ssh, the Drone server will upload a script to each host. The script will
   
.. Log in to our private docker registry
.. Pull the new image
.. Stop the old container
.. Start the new container
.. Delete old images
.. Log out of the docker registry 

+
If this script fails on a host or the web application doesn’t become accessible with HTTP code 2XX on /status, the deployment will stop and be marked as failed.
   
. Create GithHub release using the version number in Minitwits pom.xml file.

This rolling release strategy will allow for 0 downtime during upgrades, but might be problematic if 2 servers have different behavior on the same endpoint.

#### System changes

Everything else than our web application must be released semi-manually using different scripts. We use terraform to manage infrastructure and a number of bash scripts to set up the servers. For example to prepare a new web server one must open a terminal in the terraform folder and run `./setup_server_drone.sh $IP`, where the IP can be found using terraforms cli or the hosting providers web panel. Some services need some manual configuration, for a deeper explanation of how to set up each application, refer to the link:https://github.com/Herover/itu-devops-h/blob/main/terraform/README.md[readme].
