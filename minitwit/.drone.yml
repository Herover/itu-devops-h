---
kind: pipeline
type: docker
name: Minitwit server

steps:
- name: build
  image: maven:3.8.4-openjdk-17-slim
  commands:
  - cd minitwit
  - chmod +x ./control.sh
  - ./control.sh build
  - ls -al
  when:
    event:
      include:
      - pull_request

- name: test
  image: maven:3.8.4-openjdk-17-slim
  commands:
  - echo Inser tests here...
  when:
    event:
      include:
      - pull_request

- name: create and push docker image
  image: plugins/docker
  settings:
    registry: registry.digitalocean.com
    username:
      from_secret: token
    password:
      from_secret: token
    repo: registry.digitalocean.com/minitwit/minitwit-server
    tags:
      - "latest"
      - "${DRONE_BUILD_NUMBER}"
    dockerfile: minitwit/Dockerfile
    context: minitwit
  when:
    event:
    - promote

- name: snyk scan
  image: docker
  environment:
    SNYK_TOKEN:
      from_secret: SNYK_TOKEN
    DO_PAT:
      from_secret: token
    IMAGE: "registry.digitalocean.com/minitwit/minitwit-server:"
    DOCKERFILE: minitwit/Dockerfile
  commands:
  - wget https://static.snyk.io/cli/latest/snyk-linux
  - chmod +x ./snyk-linux
  - apk add libstdc++ libgcc gcompat
  - ./snyk-linux auth ${SNYK_TOKEN}
  - ./snyk-linux container test --file=${DOCKERFILE} --username=${DO_PAT} --password=${DO_PAT} ${IMAGE}:${DRONE_BUILD_NUMBER}
  when:
    event:
    - promote

- name: update live docker images
  image: alpine:3.15.0
  environment:
    DOCKER_USERNAME:
      from_secret: token
    DOCKER_PASSWORD:
      from_secret: token
    ROOT_PASSWORD:
      from_secret: root_password
    WEB_HOST:
      "143.198.249.10"
  commands:
  - apk add --no-cache sshpass openssh
  - sshpass -p "$ROOT_PASSWORD" scp -o StrictHostKeyChecking=no terraform/files/update_image.sh root@$WEB_HOST:/tmp/
  - sshpass -p "$ROOT_PASSWORD" ssh -o StrictHostKeyChecking=no root@$WEB_HOST chmod +x /tmp/update_image.sh
  - sshpass -p "$ROOT_PASSWORD" ssh -o StrictHostKeyChecking=no root@$WEB_HOST /tmp/update_image.sh registry.digitalocean.com/minitwit/minitwit-server $DRONE_BUILD_NUMBER $DOCKER_USERNAME $DOCKER_PASSWORD
  when:
    event:
    - promote

---

kind: signature
hmac: 9c94382d2c70763de1e420440f05bc4321f778733f7a7a6f4bcc148341cc29d3